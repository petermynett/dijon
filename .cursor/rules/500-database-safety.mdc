---
description: SQLite safety guardrails for any code that opens or mutates the project database (no destructive ops without approval; transactions required).
globs:
  - "src/**/db/**/*.py"
  - "src/**/database/**/*.py"
  - "tests/**/db/**/*.py"
  - "tests/**/database/**/*.py"
  - "migrations/**/*.sql"
alwaysApply: false
---

# SQLite Safety Rules

Applies to code paths that open, write, migrate, reset, or otherwise mutate an SQLite database.

## Stop-and-Ask (Required Approval)

Stop and ask before doing or proposing:

- Dropping tables, deleting the DB file, or any “reset”
- Destructive schema changes (DROP/ALTER that can lose data)
- Irreversible migrations or backfills
- Changing DB file locations, naming, or discovery rules
- Introducing a new migration system or tooling

## Safe Defaults

- Default to non-destructive operations
- Prefer idempotent initialization (create-if-missing, migrate-forward)
- Do not “fix” failures by wiping the database unless explicitly instructed

## Transactions

For any multi-step write operation:

- Use an explicit transaction
- Commit only after all steps succeed
- Roll back on any error

Do not leave the database in a partially-written state.

## Database File Handling

- Do not overwrite existing DB files silently
- If creating a new DB file, do so intentionally and explicitly
- If writing to a path that already exists, require confirmation (e.g. `--yes`) or use a safe new path

## Testing

- Tests must not destroy a user’s on-disk DB by default
- Prefer per-test temporary DB files or in-memory DBs for unit tests

## Documentation

If DB behavior changes (schema, file location, migrations, CLI flags):

- Update `DATA.md` (contracts) and/or `README.md` (usage) as appropriate