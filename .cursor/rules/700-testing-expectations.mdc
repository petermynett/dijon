---
description: Testing discipline: when and how to run pytest, with strict isolation from real data and databases.
globs:
  - "src/**/*.py"
  - "tests/**/*.py"
  - "pyproject.toml"
alwaysApply: false
---

# Testing Expectations

This rule defines **when and how to run pytest** and **how to report results**.
Test design patterns (fixtures, parametrization, integration harnesses) belong in docs/testing.md.
See docs/testing.md for full procedures.

## Modes

### Fast (Default)
After any non-trivial code change, run the smallest relevant pytest command:

- Prefer the closest test file(s) when obvious:
  - `pytest -q tests/path/to/test_thing.py`
- If not obvious, run the full suite:
  - `pytest -q`

### Full (Stronger)
Use when changes affect core behavior, CLI interfaces, or database code paths:

- `pytest`

## When Tests Are Required

Run **Fast mode** when changes affect behavior or execution paths, including:

- Logic, validation, parsing
- CLI behavior or options
- Database access code paths
- Data pipeline transforms

## When Tests Are Optional

Tests are optional for:

- Docs-only changes
- Comments or formatting-only changes with no behavior impact

## Data & Database Isolation (Required)

By default, tests MUST:

- Use temporary directories (e.g. pytest `tmp_path`) for all filesystem writes
- Use in-memory or temporary SQLite databases only
- Treat committed test fixtures as read-only and copy them before use
- Avoid reading from or writing to the project `data/` tree

Tests must not delete, modify, or migrate any real on-disk database or canonical data by default.

## Integration / DB Safety (Opt-in)

- Integration or DB-heavy tests are opt-in only
- Do not add or run destructive integration tests unless explicitly requested
- Any test that touches persistent data must be clearly documented as such

## Output Requirements

At the end of the task, state one of:

- `Tests: PASSED` + exact command(s) run
- `Tests: FAILED` + exact command(s) run + brief failure summary
- `Tests: NOT RUN` + why + exact command(s) to run

Do not claim tests passed unless they were executed.
