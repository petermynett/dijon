---
description: Global agent guardrails: safety, scope control, and stop-and-ask requirements for all work in this repo.
globs: []
alwaysApply: true
---

# Core Agent Guardrails (Always Apply)

## Authority
- Treat `AGENTS.md` as the primary safety authority for how changes are made.
- If this rule conflicts with any other rule or instruction, stop and ask.

## Mandatory context checks
Before making non-trivial changes, consult relevant authoritative docs:
- `AGENTS.md` (safety invariants)
- `README.md` (intended usage)
- `ARCHITECTURE.md` (boundaries, extension points)
- `DATA.md` (data layers, schemas, contracts)
Non-trivial = changes affecting CLI interface, data contracts, DB schema, public API, packaging/build, or cross-module refactors.

If consulted, report which files were read (see Output Requirements).

## Stop-and-ask conditions
Stop and ask for explicit approval if the request is ambiguous, underspecified, or conflicts with documented invariants.

Stop and ask before performing or proposing:
- destructive operations (delete/overwrite data, manifests, snapshots),
- database resets, drops, migrations, or irreversible schema changes,
- mass renames or broad refactors,
- changes to identity schemes, manifests, or canonical formats,
- adding or installing dependencies, tooling, or external integrations,
- adding external communications, telemetry, or unsafe secret handling.

## Safety defaults
- Prefer the smallest change that satisfies the request.
- Avoid drive-by refactors unless explicitly requested.
- Formatting-only changes are acceptable only when localized and behavior-preserving.
- Do not invent APIs, file paths, commands, contracts, ID schemes, or formats. Use existing ones or ask.

## Testing expectations
- When a change affects behavior or code paths, run the most relevant tests.
- If tests are not run, explicitly state why and provide the exact command(s) to run later.
- Testing requirements do not apply to trivial changes (comments, docs, no-behavior edits).

## Documentation sync
- If behavior, contracts, schemas, or interfaces change, update the relevant CAPS docs (`README.md`, `ARCHITECTURE.md`, `DATA.md`, `AGENTS.md`) or stop and ask.

## Dependency policy enforcement
- Do not add or install dependencies without explicit approval.
- Follow the package sourcing policy defined in `AGENTS.md`.

## Output requirements
At the end of the task, output:
- `Rules applied:` followed by the list of rules used.
- `Consulted:` followed by authoritative docs read (if any).
- Canary phrase: `RULES_OK`